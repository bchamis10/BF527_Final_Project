---
title: "GEO Expression Analysis - Z-score Normalized"
output:
  pdf_document: default
  html_document: default
---

```{r setup}
# ---- Load packages ----
# Note: If org.Hs.eg.db is not installed, run these commands first:
# if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager")
# BiocManager::install("org.Hs.eg.db")

library(dplyr)          # Data manipulation
library(tidyr)          # Data reshaping
library(tibble)         # Modern data frames
library(ggplot2)        # Plotting
library(ggpubr)         # Publication-ready plots with statistics
library(GEOquery)       # Download GEO datasets and annotations
library(org.Hs.eg.db)   # Human gene annotations (Entrez ID to Symbol mapping)
library(AnnotationDbi)  # Annotation database interface
```

```{r load-data}
# ---- Read expression data ----
# These are Series Matrix files downloaded from GEO
# comment.char = "!" skips metadata lines at the top of the file
GSE76808 <- read.table("GEO_datasets/GSE76808_series_matrix.txt", header = TRUE, row.names = 1,
                       sep = "\t", comment.char = "!", check.names = FALSE)
GSE48149 <- read.table("GEO_datasets/GSE48149_series_matrix.txt", header = TRUE, row.names = 1,
                       sep = "\t", comment.char = "!", check.names = FALSE)
GSE81292 <- read.table("GEO_datasets/GSE81292_series_matrix.txt", header = TRUE, row.names = 1,
                       sep = "\t", comment.char = "!", check.names = FALSE)

# Read metadata (sample sheet with Sample ID and Condition columns)
metadata <- read.csv('samplesheet.csv', header = TRUE)
```

```{r filter data}
# ---- Filter expression data to only samples in metadata ----
# This removes samples from unwanted groups

samples_to_keep <- metadata$Sample

cat("Original sample counts:\n")
cat("GSE76808:", ncol(GSE76808), "samples\n")
cat("GSE48149:", ncol(GSE48149), "samples\n")
cat("GSE81292:", ncol(GSE81292), "samples\n\n")

GSE76808 <- GSE76808 %>% dplyr::select(any_of(samples_to_keep))
GSE48149 <- GSE48149 %>% dplyr::select(any_of(samples_to_keep))
GSE81292 <- GSE81292 %>% dplyr::select(any_of(samples_to_keep))

cat("After filtering to metadata samples:\n")
cat("GSE76808:", ncol(GSE76808), "samples\n")
cat("GSE48149:", ncol(GSE48149), "samples\n")
cat("GSE81292:", ncol(GSE81292), "samples\n\n")
```


```{r get-annotations}
# ---- Download platform annotations ----
# Each GEO dataset uses a specific microarray platform (GPL)
# We need the platform annotations to map probe IDs to gene symbols

gse1 <- getGEO("GSE76808", GSEMatrix = FALSE)
gse2 <- getGEO("GSE48149", GSEMatrix = FALSE)
gse3 <- getGEO("GSE81292", GSEMatrix = FALSE)

# Extract platform IDs
GPL1 <- gse1@gsms[[1]]@header$platform_id
GPL2 <- gse2@gsms[[1]]@header$platform_id
GPL3 <- gse3@gsms[[1]]@header$platform_id

# Download platform annotation tables
gpl1 <- getGEO(GPL1, AnnotGPL = TRUE)
gpl2 <- getGEO(GPL2, AnnotGPL = TRUE)
gpl3 <- getGEO(GPL3, AnnotGPL = TRUE)

annot1 <- Table(gpl1)
annot2 <- Table(gpl2)
annot3_raw <- Table(gpl3)

# Note: GPL18991 (used by GSE81292) doesn't have gene symbols directly
# It has Entrez Gene IDs in the "ORF" column, which we convert to symbols
```

```{r define-genes}
# ---- Define genes of interest ----
genes_of_interest <- c(
  "MMP7", "KRT17", "SPP1", "GDF15",
  "CDKN2A", "FRZB", "PDE1A", "NAP1L2"
)

# Note: Not all platforms measure all genes
# KRT17 is missing from GPL571 (GSE76808)
```

```{r process-GSE76808}
# ---- Process GSE76808 ----
# Platform: GPL571 (Affymetrix Human Genome U133A 2.0 Array)

# Map probes to gene symbols
GSE76808_mapped <- GSE76808 %>%
  rownames_to_column("ProbeID")

# Create annotation subset
# Using bracket notation to avoid backtick issues with "Gene symbol" column name
annot1_subset <- data.frame(
  ID = annot1$ID,
  Gene = annot1[["Gene symbol"]],
  stringsAsFactors = FALSE
)

GSE76808_mapped <- GSE76808_mapped %>%
  left_join(annot1_subset, by = c("ProbeID" = "ID")) %>%
  filter(!is.na(Gene) & Gene != "")

# Filter for genes of interest and collapse duplicate probes
# Multiple probes can map to the same gene; we take the mean expression
GSE76808_collapsed <- GSE76808_mapped %>%
  filter(Gene %in% genes_of_interest) %>%
  dplyr::select(-ProbeID) %>%
  group_by(Gene) %>%
  summarize(across(where(is.numeric), mean), .groups = "drop")

# Convert to long format for ggplot
expr_long_76808 <- GSE76808_collapsed %>%
  pivot_longer(
    cols = -Gene,
    names_to = "Sample",
    values_to = "Expression"
  ) %>%
  left_join(metadata, by = "Sample") %>%
  mutate(Dataset = "GSE76808")
```

```{r process-GSE48149}
# ---- Process GSE48149 ----
# Platform: GPL16221 (Illumina HumanHT-12 WG-DASL V4.0)

GSE48149_mapped <- GSE48149 %>%
  rownames_to_column("ProbeID")

# Create annotation subset
annot2_subset <- data.frame(
  ID = annot2$ID,
  Gene = annot2$Symbol,
  stringsAsFactors = FALSE
)

GSE48149_mapped <- GSE48149_mapped %>%
  left_join(annot2_subset, by = c("ProbeID" = "ID")) %>%
  filter(!is.na(Gene) & Gene != "")

# Filter for genes of interest and collapse duplicates
GSE48149_collapsed <- GSE48149_mapped %>%
  filter(Gene %in% genes_of_interest) %>%
  dplyr::select(-ProbeID) %>%
  group_by(Gene) %>%
  summarize(across(where(is.numeric), mean), .groups = "drop")

# Convert to long format and remove samples with missing condition info
expr_long_48149 <- GSE48149_collapsed %>%
  pivot_longer(
    cols = -Gene,
    names_to = "Sample",
    values_to = "Expression"
  ) %>%
  left_join(metadata, by = "Sample") %>%
  filter(!is.na(Condition)) %>%
  mutate(Dataset = "GSE48149")
```

```{r process-GSE81292}
# ---- Process GSE81292 ----
# Platform: GPL18991 (Affymetrix Human Gene 1.1 ST Array)
# This platform uses Entrez Gene IDs instead of gene symbols

# Map Entrez IDs to gene symbols using org.Hs.eg.db
gene_symbols <- mapIds(org.Hs.eg.db, 
                       keys = as.character(annot3_raw$ORF),
                       column = "SYMBOL",
                       keytype = "ENTREZID",
                       multiVals = "first")

# Create annotation subset
# Note: Some Entrez IDs may not map to symbols (returns NA)
annot3_subset <- data.frame(
  ID = annot3_raw$ID,
  Gene = as.character(gene_symbols[as.character(annot3_raw$ORF)]),
  stringsAsFactors = FALSE
) %>%
  filter(!is.na(Gene) & Gene != "")

GSE81292_mapped <- GSE81292 %>%
  rownames_to_column("ProbeID") %>%
  left_join(annot3_subset, by = c("ProbeID" = "ID")) %>%
  filter(!is.na(Gene) & Gene != "")

# Filter for genes of interest and collapse duplicates
GSE81292_collapsed <- GSE81292_mapped %>%
  filter(Gene %in% genes_of_interest) %>%
  dplyr::select(-ProbeID) %>%
  group_by(Gene) %>%
  summarize(across(where(is.numeric), mean), .groups = "drop")

# Convert to long format and remove samples with missing condition info
expr_long_81292 <- GSE81292_collapsed %>%
  pivot_longer(
    cols = -Gene,
    names_to = "Sample",
    values_to = "Expression"
  ) %>%
  left_join(metadata, by = "Sample") %>%
  filter(!is.na(Condition)) %>%
  mutate(Dataset = "GSE81292")
```

```{r combine-and-normalize}
# ---- Combine datasets and apply Z-score normalization ----

# First, combine all raw expression data
expr_combined_raw <- bind_rows(
  expr_long_76808,
  expr_long_48149,
  expr_long_81292
)

# Set factor levels to ensure consistent ordering
expr_combined_raw$Condition <- factor(expr_combined_raw$Condition, 
                                      levels = c("control", "SSc-ILD"))
expr_combined_raw$Dataset <- factor(expr_combined_raw$Dataset,
                                    levels = c("GSE76808", "GSE48149", "GSE81292"))

cat("Expression range before normalization:\n")
expr_combined_raw %>%
  group_by(Dataset) %>%
  summarize(
    Min = min(Expression, na.rm = TRUE),
    Max = max(Expression, na.rm = TRUE),
    Mean = mean(Expression, na.rm = TRUE),
    Median = median(Expression, na.rm = TRUE)
  ) %>%
  print()

# ---- Apply Z-score normalization within each dataset ----
# This transforms each dataset to have mean=0 and SD=1
# This makes datasets comparable while preserving relative differences
expr_combined <- expr_combined_raw %>%
  group_by(Dataset, Gene) %>%
  mutate(Expression_zscore = scale(Expression)[,1]) %>%
  ungroup()

cat("\n\nExpression range after Z-score normalization:\n")
expr_combined %>%
  group_by(Dataset) %>%
  summarize(
    Min = min(Expression_zscore, na.rm = TRUE),
    Max = max(Expression_zscore, na.rm = TRUE),
    Mean = mean(Expression_zscore, na.rm = TRUE),
    SD = sd(Expression_zscore, na.rm = TRUE)
  ) %>%
  print()
```

```{r verify-output}
# ---- Verify the output ----
cat("\n\nCombined dataset summary:\n")
cat("Total rows:", nrow(expr_combined), "\n")
cat("Unique genes:", n_distinct(expr_combined$Gene), "\n")
cat("Unique datasets:", n_distinct(expr_combined$Dataset), "\n\n")

# Check counts by dataset
expr_combined %>%
  group_by(Dataset) %>%
  summarize(
    Rows = n(),
    Genes = n_distinct(Gene),
    Samples = n_distinct(Sample)
  ) %>%
  print()

# List which genes are present in each dataset
cat("\nGenes by dataset:\n")
expr_combined %>%
  group_by(Dataset) %>%
  summarize(Genes = paste(sort(unique(Gene)), collapse=", ")) %>%
  print()
```

```{r normalized-plots}
# ---- Create plots with Z-score normalized data ----
# Using base ggplot2 for better control over point positioning

comparisons <- list(c("control", "SSc-ILD"))

# Main combined plot - each gene in one panel, all 3 studies side by side
p_combined <- ggplot(expr_combined, aes(x = Dataset, y = Expression_zscore, fill = Condition)) +
  geom_boxplot(position = position_dodge(0.75), outlier.shape = NA) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.75),
             size = 1.5, alpha = 0.6, shape = 21, color = "black", stroke = 0.3) +
  stat_compare_means(aes(group = Condition), 
                     method = "t.test", 
                     label = "p.signif",
                     label.y.npc = 0.95) +
  facet_wrap(~ Gene, scales = "free_y", ncol = 4) +
  scale_fill_manual(values = c("#0073C2FF", "#EFC000FF")) +  # jco palette colors
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(size = 11, face = "bold"),
    legend.position = "bottom"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.15))) +
  labs(
    title = "Gene Expression Across Three Studies (Z-score Normalized)",
    subtitle = "Z-score normalization enables cross-platform comparison",
    x = "Dataset",
    y = "Expression (Z-score)",
    fill = "Condition"
  )

ggsave("expression_plots/combined_genes_zscore.png", plot = p_combined, 
       width = 12, height = 8, dpi = 300)

print(p_combined)
```

```{r individual-plots}
# ---- Individual dataset plots with Z-score normalization ----

expr_76808_norm <- expr_combined %>% filter(Dataset == "GSE76808")
expr_48149_norm <- expr_combined %>% filter(Dataset == "GSE48149")
expr_81292_norm <- expr_combined %>% filter(Dataset == "GSE81292")

comparisons <- list(c("control", "SSc-ILD"))

# GSE76808 (Z-score normalized)
p_76808 <- ggplot(expr_76808_norm, aes(x = Condition, y = Expression_zscore, fill = Condition)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitter(width = 0.2),
             size = 2, alpha = 0.6, shape = 21, color = "black", stroke = 0.3) +
  stat_compare_means(comparisons = comparisons, method = "t.test", label = "p.signif") +
  facet_wrap(~ Gene, scales = "free_y", nrow = 2) +
  scale_fill_manual(values = c("#0073C2FF", "#EFC000FF")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2))) +
  labs(title = "GSE76808 - Gene Expression (Z-score Normalized)",
       y = "Expression (Z-score)")

# GSE48149 (Z-score normalized)
p_48149 <- ggplot(expr_48149_norm, aes(x = Condition, y = Expression_zscore, fill = Condition)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitter(width = 0.2),
             size = 2, alpha = 0.6, shape = 21, color = "black", stroke = 0.3) +
  stat_compare_means(comparisons = comparisons, method = "t.test", label = "p.signif") +
  facet_wrap(~ Gene, scales = "free_y", nrow = 2) +
  scale_fill_manual(values = c("#0073C2FF", "#EFC000FF")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2))) + 
  labs(title = "GSE48149 - Gene Expression (Z-score Normalized)",
       y = "Expression (Z-score)")

# GSE81292 (Z-score normalized)
p_81292 <- ggplot(expr_81292_norm, aes(x = Condition, y = Expression_zscore, fill = Condition)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitter(width = 0.2),
             size = 2, alpha = 0.6, shape = 21, color = "black", stroke = 0.3) +
  stat_compare_means(comparisons = comparisons, method = "t.test", label = "p.signif") +
  facet_wrap(~ Gene, scales = "free_y", nrow = 2) +
  scale_fill_manual(values = c("#0073C2FF", "#EFC000FF")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2))) + 
  labs(title = "GSE81292 - Gene Expression (Z-score Normalized)",
       y = "Expression (Z-score)")

# Save individual plots
ggsave("expression_plots/GSE76808_genes_zscore.png", plot = p_76808, width = 9, height = 6, dpi = 300)
ggsave("expression_plots/GSE48149_genes_zscore.png", plot = p_48149, width = 9, height = 6, dpi = 300)
ggsave("expression_plots/GSE81292_genes_zscore.png", plot = p_81292, width = 9, height = 6, dpi = 300)

print(p_76808)
print(p_48149)
print(p_81292)
```

# Summary:

## Z-score Normalization
- Transforms each gene within each dataset to have mean=0 and SD=1
- Makes cross-platform comparisons valid while preserving relative differences
- Solves the problem of Illumina dataset having much higher raw expression values

## Improved Point Display
- Points are now positioned over their respective conditions (control or SSc-ILD)
- Uses `position_jitterdodge()` for the combined plot to properly dodge by condition
- Uses `position_jitter()` for individual plots
- Points are semi-transparent with black outlines for better visibility

## Output Files:
- `combined_genes_zscore.png` - Main plot showing all 3 studies for each gene
- `GSE76808_genes_zscore.png` - Individual GSE76808 plot
- `GSE48149_genes_zscore.png` - Individual GSE48149 plot  
- `GSE81292_genes_zscore.png` - Individual GSE81292 plot

## Key Features:
- Control always on the left, SSc-ILD on the right
- Each gene in its own panel
- All three studies visible side-by-side
- Statistical significance testing (t-test)
- Properly positioned jitter points over their respective conditions
