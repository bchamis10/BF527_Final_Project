---
title: "Boxplots"
output: html_document
---

```{r}
# ---- Load packages ----
library(dplyr)
library(tidyr)
library(tibble)
library(ggplot2)
library(ggpubr)
```

```{r}
# ---- Read expression data ----
# Download series matrix file from GEO
file <- "GSE76808_series_matrix.txt"

expr <- read.table(file, 
                   header = TRUE, 
                   row.names = 1, 
                   sep = "\t", 
                   comment.char = "!", 
                   check.names = FALSE)

# ---- Read metadata ----
metadata <- read.csv("samplesheet.csv", stringsAsFactors = FALSE)

metadata$Condition <- factor(metadata$Condition)
```

```{r}
# ---- Define probe-to-gene mapping ----
probe_to_gene <- c(
  "204259_at"   = "MMP7",
  "205157_s_at" = "KRT17",
  "209875_s_at" = "SPP1",
  "221576_at"   = "GDF15",
  "211156_at"   = "CDKN2A",
  "203698_s_at" = "FRZB",
  "208396_s_at" = "PDE1A",
  "219368_at"   = "NAP1L2"
)

# ---- Define gene sets ----
genes_of_interest_aging <- c("211156_at", "203698_s_at", "208396_s_at", "219368_at")
genes_of_interest_upreg <- c("204259_at", "205157_s_at", "209875_s_at", "221576_at")

# ---- Subset expression matrix ----
expr_subset_aging <- expr[rownames(expr) %in% genes_of_interest_aging, ]
expr_subset_upreg <- expr[rownames(expr) %in% genes_of_interest_upreg, ]

# Replace rownames with gene symbols
rownames(expr_subset_aging) <- probe_to_gene[rownames(expr_subset_aging)]
rownames(expr_subset_upreg) <- probe_to_gene[rownames(expr_subset_upreg)]

# ---- Convert to long format for ggplot ----
expr_long_aging <- expr_subset_aging %>%
  as.data.frame() %>%
  rownames_to_column(var = "Gene") %>%
  pivot_longer(-Gene, names_to = "Sample", values_to = "Expression") %>%
  left_join(metadata, by = "Sample")

expr_long_upreg <- expr_subset_upreg %>%
  as.data.frame() %>%
  rownames_to_column(var = "Gene") %>%
  pivot_longer(-Gene, names_to = "Sample", values_to = "Expression") %>%
  left_join(metadata, by = "Sample")
```

```{r}
# ---- Boxplots with significance bars ----
# ---- Define pairwise comparisons ----
comparisons <- list(c("control", "SSc-ILD"))

# Aging genes with significance bars
p_aging <- ggboxplot(expr_long_aging, x = "Condition", y = "Expression", fill = "Condition",
          palette = "jco", add = "jitter",
          facet.by = "Gene", scales = "free_y") +
  stat_compare_means(comparisons = comparisons, method = "t.test", label = "p.signif") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2))) + 
  labs(title = "Expression of Aging Genes by Condition")

# Upregulated genes with significance bars (already mostly correct)
p_upreg <- ggboxplot(expr_long_upreg, x = "Condition", y = "Expression", fill = "Condition",
          palette = "jco", add = "jitter",
          facet.by = "Gene", scales = "free_y") +
  stat_compare_means(comparisons = comparisons, method = "t.test", label = "p.signif") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2))) + 
  labs(title = "Expression of Upregulated Genes by Condition")

ggsave("aging_genes.png", plot = p_aging, width = 8, height = 6, dpi = 300)
ggsave("upregulated_genes.png", plot = p_upreg, width = 8, height = 6, dpi = 300)
```
